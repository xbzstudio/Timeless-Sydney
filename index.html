<!DOCTYPE html>
<html>
    <head>
        <title>Timeless Sydney v1.8</title>
        <link rel="shortcut icon" href="./static/Bing.png">
        <base target="_blank" />
        <meta charset="utf-8">
        <script src="./static/angular.min.js"></script>
        <link rel="stylesheet" href="./static/default.min.css">
        <link rel="stylesheet" href="./static/main.css">
        <script src="./static/highlight.min.js"></script>
        <script src="./static/marked.min.js"></script>
        <link rel="stylesheet" href="./static/mdui.min.css">
    </head>
    <body style="margin:0px;background-size:cover;background-attachment: fixed;">
        <div ng-app="BingAI" ng-controller="BingCTRL">
            <div class="chat">
                <br><br><br>
                <div ng-repeat="msg in chatHistory" style="clear:both;">
                    <br><br><br>
                    <div class="message" style="margin-top:0px;">
                        <img src="{{msg.headimg}}" style="float:left;margin-top:0.5%;margin-left:45%;width:30px;height:30px;"><br>
                        <p style="font-size:18;color:white;margin:0px;">{{msg.user}}</p>
                        <div style="clear:both;"></div>
                        <div style="text-align: center;">
                        <p style="color:white;font-size:15;white-space: pre-line;" ng-bind-html="msg.content"></p>
                        </div>
                        <div style="margin-left:28%;">
                            <div ng-repeat="url in msg.urls">
                                <a href="{{url.url}}" style="float:left;margin-left:3%;font-size: 17;">{{url.name}}</a>
                            </div>
                        </div>
                        <div style="clear:both;"></div>
                        <br>
                        <div style="margin-left:25%;">
                            <div ng-repeat="sug in msg.suggested">
                                <button class="mdui-btn mdui-color-blue mdui-ripple mdui-btn-dense mdui-btn-raised" style="float:left;margin-right:2%;" ng-click="useSug(sug)">{{sug}}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <br><br><br><br><br><br><br><br><br><br>
            <!-- ä½¿ç”¨é¡¶éƒ¨æ ç±»åŒ…è£¹æŒ‰é’®å’Œæ ‡é¢˜ -->
            <div class="topbar">
                <h3 class="title">Timeless Sydney v1.8</h3>
                <button class="mdui-btn mdui-color-green mdui-ripple mdui-ripple-yellow mdui-btn-raised" ng-click="newConnect()">
                    é‡è¿
                </button>
                <button class="mdui-btn mdui-color-grey mdui-ripple mdui-ripple-black mdui-btn-raised" mdui-dialog="{target: '#settings'}">
                    è®¾ç½®
                </button>
                <!-- ä½¿ç”¨æ ‡é¢˜ç±»ç»™æ ‡é¢˜æ·»åŠ æ ·å¼ -->
            </div>
            <div class="mdui-dialog" id="settings">
                <div class="mdui-dialog-title">è®¾ç½®</div>
                <div class="mdui-dialog-content">
                    <p>åœ¨æ­¤é…ç½®ä½ çš„ä¸“å±å®¢æˆ·ç«¯</p>
                    <div ng-show="usc">
                        <p style="margin:0px;">Cookie(å¿…å¡«):</p>
                        <div class="mdui-textfield" style="padding:0px;">
                            <input class="mdui-textfield-input" type="text" placeholder="User Cookie" ng-model="cookie" style="padding:0px;">
                        </div>
                    </div>
                    <div>
                        <p style="margin:0px;">è¿æ¥è‡³çš„æœåŠ¡å™¨åœ°å€:</p>
                        <div class="mdui-textfield" style="padding:0px;">
                            <input class="mdui-textfield-input" type="text" placeholder="Host" ng-model="host" style="padding:0px;">
                        </div>
                    </div>
                    <div>
                        <p style="margin:0px;">æœåŠ¡å™¨ç«¯å£:</p>
                        <div class="mdui-textfield" style="padding:0px;">
                            <input class="mdui-textfield-input" type="text" placeholder="Port" ng-model="port" style="padding:0px;">
                        </div>
                    </div>
                    <div>
                        <p style="margin:0px;">èƒŒæ™¯å›¾åƒåœ°å€:</p>
                        <div class="mdui-textfield" style="padding:0px;">
                            <input class="mdui-textfield-input" type="text" placeholder="BackgroundUrl" ng-model="backgroundUrl" style="padding:0px;">
                        </div>
                        <button class="mdui-btn mdui-ripple mdui-color-grey mdui-btn-dense mdui-btn-raised" ng-click="refreshBackground()">åˆ·æ–°èƒŒæ™¯</button>
                    </div>
                    <div>
                        <p style="margin:0px;">èŠå¤©é£æ ¼:</p>
                        <select class="mdui-select" mdui-select="{position: 'bottom'}" ng-model="style">
                            <option value="creative">creative</option>
                            <option value="balanced">balanced</option>
                            <option value="precise">precise</option>
                        </select>
                    </div>
                    <div>
                        <p style="margin:0px;">å’’è¯­:</p>
                        <div class="mdui-textfield" style="padding:0px;">
                            <input class="mdui-textfield-input" type="text" placeholder="Tip" ng-model="tipName" style="padding:0px;">
                        </div>
                        <p style="margin:0px;">Timeless Sydneyæä¾›äº†å†…ç½®çš„å’’è¯­æ¨¡æ¿,ä»…éœ€è¦åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ¨¡æ¿çš„åç§°,å°±å¯ä»¥ä½¿ç”¨è¯¥æ¨¡æ¿,è€Œä¸éœ€è¦æ‰‹åŠ¨é»è´´å’’è¯­.</p>
                        <p style="margin:0px;">å¦‚æœæƒ³è¦ä½¿ç”¨è‡ªå·±çš„å’’è¯­,ä¹Ÿå¯ä»¥åœ¨è¾“å…¥æ¡†ç›´æ¥é»è´´,Timeless Sydneyä¼šè‡ªåŠ¨åˆ¤å®šä¸ºä¸€ä¸ªå•ç‹¬çš„å’’è¯­,å¹¶ä½¿ç”¨å®ƒ.</p>
                        <p style="margin: 0px;">ä»¥ä¸‹æ˜¯é¡¹ç›®éƒ¨ç½²è€…æä¾›çš„æ‰€æœ‰ç›®å‰å¯ä½¿ç”¨æ¨¡æ¿çš„åç§°:</p>
                        <div ng-repeat="tip in canChooseTips">
                            <a style="margin-right:3%;float:left;">{{tip}}</a>
                        </div>
                        <div style="clear: both;"></div>
                    </div>
                    <div>
                        <p style="margin:0px;">ä½¿ç”¨wssåè®®:</p>
                        <label class="mdui-checkbox">
                            <input type="checkbox"/ ng-model="wss">
                            <i class="mdui-checkbox-icon"></i>
                            {{wss}}
                        </label>
                    </div>
                </div>
                <div class="mdui-dialog-actions">
                  <button class="mdui-btn mdui-ripple" mdui-dialog-close>å®Œæˆ</button>
                </div>
            </div>
            <div class="inputbox">
                <div>
                    <div class="mdui-textfield mdui-textfield-floating-label" style="float:left;">
                        <label class="mdui-textfield-label">ç”¨æˆ·ä¿¡æ¯</label>
                        <textarea class="mdui-textfield-input mdui-color-white" maxlength="4000" id="textareaSty" style="min-height: 75px;max-height: 150px;" ng-model="userInput"></textarea>
                    </div>
                    <div class="mdui-textfield-helper">Ctrl + Enter ä»¥å¿«æ·å‘é€</div>
                    <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-blue" id="sendButton" ng-click="sendMessage()"><p style="margin:0px;color:rgb(255, 255, 255);">å‘é€</p></button>
                </div>
            </div>
            <script src="./static/mdui.min.js"></script>
            <script src="./config/client.js"></script>
            <script type="module">
                var textarea = document.getElementById('textareaSty');
                var button = document.getElementById('sendButton')
                textarea.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && (e.keyCode == 13 || e.keyCode == 10)) {
                    // Ctrl + Enter pressed
                        button.click(); // trigger the button's onclick function
                    }
                })
                var app = angular.module('BingAI', [])
                app.controller('BingCTRL',function($scope, $sce){
                    $scope.chatHistory = [{
                        'content' : $sce.trustAsHtml(marked.parse('ğŸ‰æ¬¢è¿æ¥åˆ°Timeless Sydney v1.8ï¼ğŸ‰\nåœ¨è¿™é‡Œ,ä½ å¯ä»¥:**è§’è‰²æ‰®æ¼”,æœç´¢ä¿¡æ¯,è·å–æœ‰ç”¨ç­”æ¡ˆ,è¿˜æœ‰æ›´å¤š!åšä½ æƒ³åšçš„ä»»ä½•äº‹,æ²¡æœ‰ä»»ä½•é™åˆ¶!**\nå¦‚æœå–œæ¬¢æœ¬é¡¹ç›®,è¯·å¤šå¤šæ”¯æŒå¾®è½¯çš„New Bing,ä»¥åŠè¯¥å®¢æˆ·ç«¯çš„å”¯ä¸€ä½œè€…xbzstudio!\n**åœ¨ä¸‹é¢çš„Linksä¸­æŸ¥çœ‹æ›´å¤š!**')),
                        'user' : 'System',
                        'headimg' : './static/Bing.png',
                        'suggested' : ['Hello', 'ä½ å¥½'],
                        'urls' : [{'name' : 'Github', 'url' : 'https://github.com/xbzstudio/Timeless-Sydney'},
                            {'name' : 'BiliBili', 'url' : 'https://space.bilibili.com/289282595?spm_id_from=333.1007.0.0'},
                            {'name' : 'Microsoft New Bing', 'url' : 'https://bing.com/new'}
                        ]
                    }]
                    $scope.bingTyping = true
                    $scope.backgroundUrl = settings.backgroundUrl
                    $scope.style = settings.style
                    $scope.tipName = settings.tipName
                    $scope.cookie = settings.cookie
                    $scope.host = settings.connectTo
                    $scope.port = settings.port
                    $scope.wss =settings.wss
                    $scope.userInput = ''
                    $scope.usc = false
                    $scope.tipList = []
                    $scope.lastTip = ''

                    function getTipList(){
                        var http = new XMLHttpRequest()
                        http.open('GET', $scope.host+':'+$scope.port + '/chat/getTipNames')
                        http.onreadystatechange = function(){
                            if (http.readyState == 4) {
                                if (http.status == 200){
                                    $scope.$apply(function(){
                                        var res = eval(http.responseText)
                                        $scope.tipList = res[0]
                                        $scope.canChooseTips = res[0]
                                        $scope.usc = res[1]
                                    })
                                }
                            }
                        }
                        http.send()
                    }

                    getTipList()

                    $scope.refreshBackground = function(){
                        document.body.style.backgroundImage = "url(" + $scope.backgroundUrl + ")";
                    }
                    $scope.refreshBackground()

                    $scope.chooseTip = function(chooseTipName){
                        $scope.$apply(function(){
                            if (!(chooseTipName == $scope.lastTip)){
                                $scope.tipName = chooseTipName
                            }
                        })
                    }

                    $scope.useSug = function(sData){
                        $scope.$applyAsync(function(){
                            $scope.userInput = sData
                        })
                    }

                    var wsclient

                    $scope.newConnect = function(){
                        $scope.tipName = settings.tipName
                        $scope.lastTip = ''
                        if ($scope.wss){
                            if ($scope.host.includes('https://')){
                                wsclient = new WebSocket('wss://' + $scope.host.substring(8) + ':' + $scope.port + '/chat/ws')
                            }
                            else{
                                wsclient = new WebSocket('wss://' + $scope.host.substring(7) + ':' + $scope.port + '/chat/ws')
                            }
                        }
                        else{
                            if ($scope.host.includes('https://')){
                                wsclient = new WebSocket('ws://' + $scope.host.substring(8) + ':' + $scope.port + '/chat/ws')
                            }
                            else{
                                wsclient = new WebSocket('ws://' + $scope.host.substring(7) + ':' + $scope.port + '/chat/ws')
                            }
                        }
                        $scope.bingTyping = false;

                        wsclient.onopen = function(){
                            if ($scope.usc){
                                wsclient.send($scope.cookie)
                            }
                        }
                        
                        wsclient.onclose = function(){
                            $scope.$applyAsync(function(){
                                $scope.chatHistory.push({
                                    'content' : $sce.trustAsHtml('âŒè¿æ¥ä¸¢å¤±âŒ'),
                                    'user' : 'System',
                                    'headimg' : './static/Bing.png',
                                    'suggested' : [],
                                    'urls' : []})
                            })
                        }

                        wsclient.onerror = function(event){
                            $scope.$applyAsync(function(){
                                $scope.chatHistory.push({
                                    'content' : $sce.trustAsHtml('å‘ç”Ÿé”™è¯¯:' + event),
                                    'user' : 'System',
                                    'headimg' : './static/Bing.png',
                                    'suggested' : [],
                                    'urls' : []})
                            })
                        }

                        wsclient.onmessage = function(event){
                            var msg = eval("("+event.data+")")
                            console.log(msg.answer)
                            $scope.$applyAsync(function(){
                                if (!msg.done){
                                    $scope.chatHistory[$scope.chatHistory.length - 1].content = $sce.trustAsHtml(marked.parse(msg.answer))
                                    $scope.chatHistory[$scope.chatHistory.length - 1].user = 'New Bing'
                                    $scope.chatHistory[$scope.chatHistory.length - 1].headimg = './static/Bing.png'
                                    $scope.chatHistory[$scope.chatHistory.length - 1].suggested = msg.suggested
                                    $scope.chatHistory[$scope.chatHistory.length - 1].urls = msg.urls
                                    hljs.highlightAll()
                                }
                                else{
                                    if (msg.error){
                                        $scope.chatHistory[$scope.chatHistory.length - 1] = $scope.chatHistory[$scope.chatHistory.length - 1] + '\n' +msg.error
                                        $scope.bingTyping = false
                                        hljs.highlightAll()
                                    }
                                    else{
                                        $scope.chatHistory[$scope.chatHistory.length - 1].content = $sce.trustAsHtml(marked.parse(msg.answer))
                                        $scope.chatHistory[$scope.chatHistory.length - 1].user = 'New Bing'
                                        $scope.chatHistory[$scope.chatHistory.length - 1].headimg = './static/Bing.png'
                                        $scope.chatHistory[$scope.chatHistory.length - 1].suggested = msg.suggested
                                        $scope.chatHistory[$scope.chatHistory.length - 1].urls = msg.urls
                                        $scope.bingTyping = false
                                        hljs.highlightAll()
                                    }
                                }
                                window.scrollTo(0, document.body.scrollHeight);
                            })
                        }
                    }

                    $scope.sendMessage = function(){
                        if (!$scope.bingTyping){
                            if ($scope.userInput){
                                $scope.bingTyping = true
                                $scope.chatHistory[$scope.chatHistory.length - 1].suggested = []
                                $scope.chatHistory.push({
                                    'content' : $sce.trustAsHtml($scope.userInput),
                                    'user' : 'User',
                                    'headimg' : './static/User.png',
                                    'suggested' : [],
                                    'urls' : []})
                                $scope.chatHistory.push({
                                    'content' : $sce.trustAsHtml('Typing...'),
                                    'user' : 'New Bing',
                                    'headimg' : './static/Bing.png',
                                    'suggested' : [],
                                    'urls' : []})
                                wsclient.send('{"tipName" : "'+$scope.tipName+'", "question":"'+$scope.userInput+'", "style":"'+$scope.style+'"}')
                                $scope.userInput = ''
                                $scope.lastTip = $scope.tipName
                                $scope.tipName = 'Bing'
                                window.scrollTo(0, document.body.scrollHeight);
                            }
                        }
                    }

                    $scope.newConnect()

                    $scope.bingTyping = false
                })
            </script>
        </div>
    </body>
</html>
